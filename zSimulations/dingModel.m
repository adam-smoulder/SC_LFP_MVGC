h = 0.0001;     % 0.1 ms step size
t = 0:h:1;      % full trial length 0 to 100s
fs = 200;       % fs to use
dur = 0.5;      % duration of each trial (s)
stdE = 0.2;     % stdev of noise signals
delay = 0.015;  % in s

N = length(t);
rawFs = 1/h;
resampleRate = round(rawFs/fs);
delayInSamp = ceil(delay*rawFs);

samplesPerTrial = dur*fs;
nTrials = round((N-1)/resampleRate/samplesPerTrial);

%Defining the parameters for the model
a = 0.22;
b = 0.72;
Kxu = 0.25;
K12 = 0.001;
K21 = 0.001;
Kie = 2.5;
Kei = 0.1;
Qm0 = 0.5;
RKCoeffs = 1/6*[1 2 2 1];

%Defining the vectors where the answer is stored.
x1    = zeros(N,1);
x2    = zeros(N,1);
y1    = zeros(N,1);
y2    = zeros(N,1);
a1    = zeros(N,1);
a2    = zeros(N,1);
b1    = zeros(N,1);
b2    = zeros(N,1);
u1    = zeros(N,1);
u2    = zeros(N,1);
v1    = zeros(N,1);
v2    = zeros(N,1);
g1    = zeros(N,1);
g2    = zeros(N,1);
p1    = zeros(N,1);
p2    = zeros(N,1);

% e_x1 = stdE*randn(2*N-1,1); % since RK does half steps in some evaluations...
% e_x2 = stdE*randn(2*N-1,1);
% e_y1 = stdE*randn(2*N-1,1);
% e_y2 = stdE*randn(2*N-1,1);
% e_u1 = stdE*randn(2*N-1,1);
% e_u2 = stdE*randn(2*N-1,1);
% e_v1 = stdE*randn(2*N-1,1);
% e_v2 = stdE*randn(2*N-1,1);

e_x1 = stdE*randn(N,1); % since RK does half steps in some evaluations...
e_x2 = stdE*randn(N,1);
e_y1 = stdE*randn(N,1);
e_y2 = stdE*randn(N,1);
e_u1 = stdE*randn(N,1);
e_u2 = stdE*randn(N,1);
e_v1 = stdE*randn(N,1);
e_v2 = stdE*randn(N,1);

dx1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) a1;
dx2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) a2;
dy1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) b1;
dy2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) b2;
% da1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*a1-a*b*x1-Kie*qf(y1,Qm0)+K12*qf(x1,Qm0)+grb(e_x1,t,h);
% da2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*a2-a*b*x2-Kie*qf(y2,Qm0)+K12*qf(x2,Qm0)+grb(e_x2,t,h);
% db1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*b1-a*b*y1+Kei*qf(x1,Qm0)+grb(e_y1,t,h);
% db2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*b2-a*b*y2+Kei*qf(x2,Qm0)+grb(e_y2,t,h);
da1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*a1-a*b*x1-Kie*qf(y1,Qm0)+K12*qf(x1,Qm0);
da2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*a2-a*b*x2-Kie*qf(y2,Qm0)+K12*qf(x2,Qm0);
db1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*b1-a*b*y1+Kei*qf(x1,Qm0);
db2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*b2-a*b*y2+Kei*qf(x2,Qm0);
du1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) g1;
du2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) g2;
dv1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) p1;
dv2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) p2;
% dg1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*g1-a*b*u1-Kie*qf(v1,Qm0)+K21*qf(u1,Qm0)+Kxu*qf(x1,Qm0)+grb(e_u1,t,h);
% dg2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*g2-a*b*u2-Kie*qf(v2,Qm0)+K21*qf(u2,Qm0)+Kxu*qf(x2,Qm0)+grb(e_u2,t,h);
% dp1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*p1-a*b*v1+Kei*qf(u1,Qm0)+grb(e_v1,t,h);
% dp2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
%     -(a+b)*p2-a*b*v2+Kei*qf(u2,Qm0)+grb(e_v2,t,h);

dg1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*g1-a*b*u1-Kie*qf(v1,Qm0)+K21*qf(u1,Qm0)+Kxu*qf(x1,Qm0);
dg2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*g2-a*b*u2-Kie*qf(v2,Qm0)+K21*qf(u2,Qm0)+Kxu*qf(x2,Qm0);
dp1    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*p1-a*b*v1+Kei*qf(u1,Qm0);
dp2    = @(t,x1,x2,y1,y2,a1,a2,b1,b2,u1,u2,v1,v2,g1,g2,p1,p2) ...
    -(a+b)*p2-a*b*v2+Kei*qf(u2,Qm0);
%% initial conditions:
x1(1) = e_x1(1);
x2(1) = e_x2(1);
y1(1) = e_y1(1);
y2(1) = e_y2(1);
a1(1) = stdE*randn;
a2(1) = stdE*randn;
b1(1) = stdE*randn;
b2(1) = stdE*randn;
u1(1) = e_u1(1);
u2(1) = e_u2(1);
v1(1) = e_v1(1);
v2(1) = e_v2(1);
g1(1) = stdE*randn;
g2(1) = stdE*randn;
p1(1) = stdE*randn;
p2(1) = stdE*randn;
% 
% x1(1) = 0;
% x2(1) = 0;
% y1(1) =  0;
% y2(1) =  0;
% a1(1) =  0;
% a2(1) =  0;
% b1(1) = 0;
% b2(1) =  0;
% u1(1) =  0;
% u2(1) = 0;
% v1(1) = 0;
% v2(1) = 0;
% g1(1) =  0;
% g2(1) =  0;
% p1(1) =  0;
% p2(1) =  0;

%% do the runge kutta

for i = 1:(N-1)
    if i > delayInSamp
        cpv1 = x1(i-delayInSamp); % coupled value
        cpv2 = x2(i-delayInSamp);
    else
        cpv1 = 0; cpv2 = 0;
    end
    
    disp(['Iter ' num2str(i) ' of ' num2str(N-1)])
    K1x1 = h*dx1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1x2 = h*dx2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1y1 = h*dy1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1y2 = h*dy2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1a1 = h*da1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1a2 = h*da2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1b1 = h*db1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1b2 = h*db2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
%     K1u1 = h*du1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
%         u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
%     K1u2 = h*du2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
%         u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1u1 = h*du1(t(i),cpv1,cpv2,y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1u2 = h*du2(t(i),cpv1,cpv2,y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1v1 = h*dv1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1v2 = h*dv2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1g1 = h*dg1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1g2 = h*dg2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1p1 = h*dp1(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    K1p2 = h*dp2(t(i),x1(i),x2(i),y1(i),y2(i),a1(i),a2(i),b1(i),b2(i),...
        u1(i),u2(i),v1(i),v2(i),g1(i),g2(i),p1(i),p2(i));
    
    K2x1 = h*dx1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2x2 = h*dx2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2y1 = h*dy1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2y2 = h*dy2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2a1 = h*da1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2a2 = h*da2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2b1 = h*db1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2b2 = h*db2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
%     K2u1 = h*du1(t(i)+h/2,...
%         x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
%         a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
%         u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
%         g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
%     K2u2 = h*du2(t(i)+h/2,...
%         x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
%         a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
%         u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
%         g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2u1 = h*du1(t(i)+h/2,...
        cpv1,cpv2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2u2 = h*du2(t(i)+h/2,...
        cpv1,cpv2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2v1 = h*dv1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2v2 = h*dv2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2g1 = h*dg1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2g2 = h*dg2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2p1 = h*dp1(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    K2p2 = h*dp2(t(i)+h/2,...
        x1(i)+K1x1/2,x2(i)+K1x2/2,y1(i)+K1y1/2,y2(i)+K1y2/2,...
        a1(i)+K1a1/2,a2(i)+K1a2/2,b1(i)+K1b1/2,b2(i)+K1b2/2,...
        u1(i)+K1u1/2,u2(i)+K1u2/2,v1(i)+K1v1/2,v2(i)+K1v2/2,...
        g1(i)+K1g1/2,g2(i)+K1g2/2,p1(i)+K1p1/2,p2(i)+K1p2/2);
    
    K3x1 = h*dx1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3x2 = h*dx2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3y1 = h*dy1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3y2 = h*dy2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3a1 = h*da1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3a2 = h*da2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3b1 = h*db1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3b2 = h*db2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
%     K3u1 = h*du1(t(i)+h/2,...
%         x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
%         a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
%         u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
%         g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
%     K3u2 = h*du2(t(i)+h/2,...
%         x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
%         a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
%         u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
%         g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3u1 = h*du1(t(i)+h/2,...
        cpv1,cpv2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3u2 = h*du2(t(i)+h/2,...
        cpv1,cpv2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3v1 = h*dv1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3v2 = h*dv2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3g1 = h*dg1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3g2 = h*dg2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3p1 = h*dp1(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    K3p2 = h*dp2(t(i)+h/2,...
        x1(i)+K2x1/2,x2(i)+K2x2/2,y1(i)+K2y1/2,y2(i)+K2y2/2,...
        a1(i)+K2a1/2,a2(i)+K2a2/2,b1(i)+K2b1/2,b2(i)+K2b2/2,...
        u1(i)+K2u1/2,u2(i)+K2u2/2,v1(i)+K2v1/2,v2(i)+K2v2/2,...
        g1(i)+K2g1/2,g2(i)+K2g2/2,p1(i)+K2p1/2,p2(i)+K2p2/2);
    
    K4x1 = h*dx1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4x2 = h*dx2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4y1 = h*dy1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4y2 = h*dy2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4a1 = h*da1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4a2 = h*da2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4b1 = h*db1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4b2 = h*db2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
%     K4u1 = h*du1(t(i)+h,...
%         x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
%         a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
%         u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
%         g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
%     K4u2 = h*du2(t(i)+h,...
%         x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
%         a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
%         u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
%         g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4u1 = h*du1(t(i)+h,...
        cpv1,cpv2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4u2 = h*du2(t(i)+h,...
        cpv1,cpv2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4v1 = h*dv1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4v2 = h*dv2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4g1 = h*dg1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4g2 = h*dg2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4p1 = h*dp1(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    K4p2 = h*dp2(t(i)+h,...
        x1(i)+K3x1,x2(i)+K3x2,y1(i)+K3y1,y2(i)+K3y2,...
        a1(i)+K3a1,a2(i)+K3a2,b1(i)+K3b1,b2(i)+K3b2,...
        u1(i)+K3u1,u2(i)+K3u2,v1(i)+K3v1,v2(i)+K3v2,...
        g1(i)+K3g1,g2(i)+K3g2,p1(i)+K3p1,p2(i)+K3p2);
    
    x1(i+1) = x1(i)+RKCoeffs*[K1x1 K2x1 K3x1 K4x1]';
    x2(i+1) = x2(i)+RKCoeffs*[K1x2 K2x2 K3x2 K4x2]';
    y1(i+1) = y1(i)+RKCoeffs*[K1y1 K2y1 K3y1 K4y1]';
    y2(i+1) = y2(i)+RKCoeffs*[K1y2 K2y2 K3y2 K4y2]';
%     a1(i+1) = a1(i)+RKCoeffs*[K1a1 K2a1 K3a1 K4a1]';
%     a2(i+1) = a2(i)+RKCoeffs*[K1a2 K2a2 K3a2 K4a2]';
%     b1(i+1) = b1(i)+RKCoeffs*[K1b1 K2b1 K3b1 K4b1]';
%     b2(i+1) = b2(i)+RKCoeffs*[K1b2 K2b2 K3b2 K4b2]';
    a1(i+1) = a1(i)+RKCoeffs*[K1a1 K2a1 K3a1 K4a1]'+e_x1(i+1);
    a2(i+1) = a2(i)+RKCoeffs*[K1a2 K2a2 K3a2 K4a2]'+e_x2(i+1);
    b1(i+1) = b1(i)+RKCoeffs*[K1b1 K2b1 K3b1 K4b1]'+e_y1(i+1);
    b2(i+1) = b2(i)+RKCoeffs*[K1b2 K2b2 K3b2 K4b2]'+e_y2(i+1);
    u1(i+1) = u1(i)+RKCoeffs*[K1u1 K2u1 K3u1 K4u1]';
    u2(i+1) = u2(i)+RKCoeffs*[K1u2 K2u2 K3u2 K4u2]';
    v1(i+1) = v1(i)+RKCoeffs*[K1v1 K2v1 K3v1 K4v1]';
    v2(i+1) = v2(i)+RKCoeffs*[K1v2 K2v2 K3v2 K4v2]';
%     g1(i+1) = g1(i)+RKCoeffs*[K1g1 K2g1 K3g1 K4g1]';
%     g2(i+1) = g2(i)+RKCoeffs*[K1g2 K2g2 K3g2 K4g2]';
%     p1(i+1) = p1(i)+RKCoeffs*[K1p1 K2p1 K3p1 K4p1]';
%     p2(i+1) = p2(i)+RKCoeffs*[K1p2 K2p2 K3p2 K4p2]';
    g1(i+1) = g1(i)+RKCoeffs*[K1g1 K2g1 K3g1 K4g1]'+e_u1(i+1);
    g2(i+1) = g2(i)+RKCoeffs*[K1g2 K2g2 K3g2 K4g2]'+e_u2(i+1);
    p1(i+1) = p1(i)+RKCoeffs*[K1p1 K2p1 K3p1 K4p1]'+e_v1(i+1);
    p2(i+1) = p2(i)+RKCoeffs*[K1p2 K2p2 K3p2 K4p2]'+e_v2(i+1);
end

%% reshape and such
X1 = resample(x1(1:end-1),1,resampleRate);
X2 = resample(x2(1:end-1),1,resampleRate);
U1 = resample(u1(1:end-1),1,resampleRate);
U2 = resample(u2(1:end-1),1,resampleRate);


X1 = reshape(X1',[1 samplesPerTrial nTrials]); % dims: chan x time x trial
X2 = reshape(X2',[1 samplesPerTrial nTrials]);
U1 = reshape(U1',[1 samplesPerTrial nTrials]);
U2 = reshape(U2',[1 samplesPerTrial nTrials]);

X = [X1;X2;U1;U2]; % dims: chan x time x trial

subplot(2,1,1)
plot(x1)
hold on
plot(x2)
plot(u1)
plot(u2)
subplot(2,1,2)
plot(squeeze(X(1,:,1)))








